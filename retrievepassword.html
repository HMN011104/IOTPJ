<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8"/>
  <title>Khôi phục mật khẩu | IOT CONTROL SYSTEM</title>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <link rel="stylesheet" href="css/styles.css"/>
</head>
<body>
<div class="bg"></div>
<div class="center-wrap">
  <div class="phone-frame">
    <div class="screen">
      <div class="brand-row">
        <img src="assets/logo.png" alt="logo" width="84" height="84"/>
        <div class="brand app-title">IOT CONTROL SYSTEM</div>
      </div>
      <div class="big-title">Khôi phục mật khẩu</div>
      <div class="card">
        <div id="step1" class="reset-step">
          <div class="field">
            <label class="label">Email</label>
            <input id="email" class="input" type="email" placeholder="test@example.com"/>
          </div>
          <button id="btnSendReset" class="btn primary block">Gửi email khôi phục</button>
          <div id="msg" class="notice" style="display:none;"></div>
        </div>

        <div id="step2" class="reset-step" style="display:none;">
          <div class="success-icon">
            <svg width="48" height="48" fill="#22c55e" viewBox="0 0 24 24">
              <path d="M9 16.2L4.8 12l-1.4 1.4L9 19 21 7l-1.4-1.4L9 16.2z"/>
            </svg>
          </div>
          <h3 style="text-align: center; color: #22c55e; margin: 16px 0;">Email đã được gửi!</h3>
          <p style="text-align: center; color: #666; margin-bottom: 24px; line-height: 1.5;">
            Chúng tôi đã gửi link khôi phục mật khẩu đến email <strong id="sentEmail"></strong>
          </p>
          <p style="text-align: center; color: #888; font-size: 14px; margin-bottom: 24px; line-height: 1.4;">
            Vui lòng kiểm tra hộp thư (bao gồm cả thư mục spam) và nhấn vào link để đặt lại mật khẩu.
          </p>
          <div style="text-align: center;">
            <button id="btnResend" class="btn secondary" style="margin-right: 8px;" disabled>
              <span id="resendText">Gửi lại</span>
              <span id="resendTimer" style="display:none;"></span>
            </button>
            <button id="btnBackToLogin" class="btn primary">Về trang đăng nhập</button>
          </div>
        </div>
      </div>

      <div class="center muted">Đã nhớ mật khẩu?
        <a class="link" href="login.html">Đăng nhập</a>
      </div>
    </div>
  </div>
</div>

<style>
.reset-step {
  transition: all 0.3s ease;
}

.success-icon {
  text-align: center;
  margin-bottom: 16px;
}

.success-icon svg {
  background: #f0fdf4;
  padding: 12px;
  border-radius: 50%;
  border: 2px solid #22c55e;
}

.btn.secondary {
  background: #6c757d;
  color: white;
  border: none;
  padding: 10px 20px;
  border-radius: 4px;
  cursor: pointer;
  font-size: 14px;
}

.btn.secondary:hover:not(:disabled) {
  background: #5a6268;
}

.btn.secondary:disabled {
  background: #cccccc;
  cursor: not-allowed;
}

#step2 h3 {
  font-size: 18px;
  font-weight: 600;
}

#step2 p {
  margin: 0;
}
</style>

<script type="module">
import { auth } from "./js/firebase-config.js";
import { sendPasswordResetEmail } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-auth.js";
import { qs, toast } from "./js/utils.js";

const email = qs("#email");
const btnSendReset = qs("#btnSendReset");
const btnResend = qs("#btnResend");
const btnBackToLogin = qs("#btnBackToLogin");
const msg = qs("#msg");
const step1 = qs("#step1");
const step2 = qs("#step2");
const sentEmail = qs("#sentEmail");
const resendText = qs("#resendText");
const resendTimer = qs("#resendTimer");

let resendCountdown;
let currentEmail = "";

// Gửi email reset password lần đầu
btnSendReset.addEventListener("click", async () => {
  const emailValue = email.value.trim();
  
  if (!emailValue) {
    toast(msg, "Vui lòng nhập email");
    return;
  }

  if (!isValidEmail(emailValue)) {
    toast(msg, "Email không hợp lệ");
    return;
  }
  
  await sendResetEmail(emailValue);
});

// Gửi lại email
btnResend.addEventListener("click", async () => {
  if (btnResend.disabled) return;
  await sendResetEmail(currentEmail);
});

// Về trang đăng nhập
btnBackToLogin.addEventListener("click", () => {
  location.href = "login.html";
});

// Hàm gửi email reset
async function sendResetEmail(emailValue) {
  btnSendReset.disabled = true;
  btnResend.disabled = true;
  
  try {
    // Cấu hình action code settings để redirect về trang của chúng ta
    const actionCodeSettings = {
      url: window.location.origin + '/login.html?message=password-reset-success',
      handleCodeInApp: false
    };
    
    await sendPasswordResetEmail(auth, emailValue, actionCodeSettings);
    
    // Chuyển sang bước 2
    currentEmail = emailValue;
    sentEmail.textContent = emailValue;
    step1.style.display = "none";
    step2.style.display = "block";
    
    // Bắt đầu đếm ngược để có thể gửi lại (60 giây)
    startResendCountdown(60);
    
  } catch (error) {
    let errorMsg = "Gửi email thất bại";
    
    switch (error.code) {
      case "auth/user-not-found":
        errorMsg = "Email không tồn tại trong hệ thống. Vui lòng kiểm tra lại hoặc đăng ký tài khoản mới.";
        break;
      case "auth/invalid-email":
        errorMsg = "Email không hợp lệ";
        break;
      case "auth/too-many-requests":
        errorMsg = "Quá nhiều yêu cầu. Vui lòng thử lại sau vài phút.";
        break;
      case "auth/network-request-failed":
        errorMsg = "Lỗi kết nối mạng. Vui lòng kiểm tra kết nối internet.";
        break;
      default:
        errorMsg = "Có lỗi xảy ra: " + error.message;
    }
    
    toast(msg, errorMsg);
  } finally {
    btnSendReset.disabled = false;
  }
}

// Đếm ngược để gửi lại email
function startResendCountdown(seconds) {
  let timeLeft = seconds;
  
  resendCountdown = setInterval(() => {
    if (timeLeft > 0) {
      resendText.style.display = "none";
      resendTimer.style.display = "inline";
      resendTimer.textContent = `Gửi lại (${timeLeft}s)`;
      btnResend.disabled = true;
      timeLeft--;
    } else {
      clearInterval(resendCountdown);
      resendText.style.display = "inline";
      resendTimer.style.display = "none";
      resendText.textContent = "Gửi lại";
      btnResend.disabled = false;
    }
  }, 1000);
}

// Kiểm tra email hợp lệ
function isValidEmail(email) {
  return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email);
}

// Xử lý khi có message từ URL params
const urlParams = new URLSearchParams(window.location.search);
if (urlParams.get('message') === 'password-reset-success') {
  toast(msg, "Mật khẩu đã được cập nhật thành công! Vui lòng đăng nhập với mật khẩu mới.", "success");
}
</script>

</body>
</html>
