<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8"/>
  <title>Main | IOT CONTROL SYSTEM</title>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <link rel="stylesheet" href="css/styles.css"/>
</head>
<body>
<div class="bg"></div>
<div class="center-wrap">
  <div class="phone-frame">
    <div class="brand-row">
        <img src="assets/logo.png" alt="logo" width="84" height="84">
        <div class="brand app-title">IOT CONTROL SYSTEM</div>
      </div>
    <div class="topbar">
      <div class="actions">
        <button id="btnProfile" class="btn">Profile</button>
      </div>
      <div class="title" id="welcomeUser">Ch√†o m·ª´ng</div>
      <div class="actions">
        <button id="btnLogout" class="btn danger">ƒêƒÉng xu·∫•t</button>
      </div>
    </div>
    <div class="screen">
      <div class="big-title">Thi·∫øt b·ªã</div>
      <div class="helper small">B·∫≠t/T·∫Øt ƒë·ªìng b·ªô realtime. M·∫°ch ƒë·ªçc field <b>status</b> t·ª´ Firestore.</div>
      <div class="hr"></div>
      <div class="bulk-actions">
        <button id="btnTurnOnAll" class="btn success bulk-btn">‚ö° B·∫≠t t·∫•t c·∫£</button>
        <button id="btnTurnOffAll" class="btn danger bulk-btn">üîå T·∫Øt t·∫•t c·∫£</button>
      </div>
      <div class="hr"></div>
      <div id="deviceList" class="list"></div>
      <div id="msg" class="notice" style="display:none;"></div>
    </div>
    <div class="bottomnav">
      <a class="tab active" href="main.html">Home</a>
      <a class="tab" href="history.html">History</a>
      <a class="tab" href="notifications.html">Notification</a>
    </div>
  </div>
</div>

<!-- Device Detail Modal -->
<div id="deviceModal" class="device-modal">
  <div class="device-modal-content">
    <div class="device-modal-header">
      <h3 id="modalDeviceName">Chi ti·∫øt thi·∫øt b·ªã</h3>
      <button class="device-modal-close">&times;</button>
    </div>
    <div class="device-modal-body">
      <div class="device-info-row">
        <span class="device-info-label">Tr·∫°ng th√°i:</span>
        <span id="modalDeviceStatus" class="device-status-badge">--</span>
      </div>
      <div class="device-info-row">
        <span class="device-info-label">Thao t√°c cu·ªëi:</span>
        <span id="modalLastUpdated">--</span>
      </div>
      <div class="device-info-row">
        <span class="device-info-label" id="modalOnTimeLabel">Thi·∫øt b·ªã ƒë√£ b·∫≠t:</span>
        <span id="modalOnTime" class="device-duration">--</span>
      </div>
      <div class="device-info-row">
        <span class="device-info-label" id="modalOffTimeLabel">Thi·∫øt b·ªã ƒë√£ t·∫Øt:</span>
        <span id="modalOffTime" class="device-duration">--</span>
      </div>
    </div>
  </div>
</div>

<script type="module">
import { requireAuth, wireTopbar } from "./js/auth-guard.js";
import { getUserDoc, listenDevicesByCircuit, toggleDevice, addHistoryWithCircuit } from "./js/firestore.js";
import { renderDevices } from "./js/ui.js";
import { fmtTime, qs, toast } from "./js/utils.js";
import { initDeviceModal } from "./js/device-modal.js";

const user = await requireAuth();
wireTopbar(user);
const udoc = await getUserDoc(user.uid);
const circuitId = udoc?.circuitId || "";
const listEl = qs("#deviceList");
const msg = qs("#msg");

// Initialize device modal
initDeviceModal();

// Bulk actions
let currentDevices = [];

// Update device list reference
const originalUnsub = listenDevicesByCircuit(circuitId, (devices)=>{
  currentDevices = devices; // Store current devices
  renderDevices(listEl, devices, async (dev, newState)=>{
    // existing toggle logic...
  });
});

// Bulk turn on all
qs("#btnTurnOnAll").addEventListener("click", async () => {
  const offDevices = currentDevices.filter(d => !d.status);
  if (offDevices.length === 0) {
    toast(msg, "T·∫•t c·∫£ thi·∫øt b·ªã ƒë√£ ƒë∆∞·ª£c b·∫≠t");
    return;
  }
  
  if (!confirm(`B·∫°n c√≥ mu·ªën b·∫≠t ${offDevices.length} thi·∫øt b·ªã?`)) return;
  
  try {
    for (const dev of offDevices) {
      await toggleDevice(dev.id, true);
      await addHistoryWithCircuit({ ...dev, status: true }, circuitId);
    }
    toast(msg, `ƒê√£ b·∫≠t ${offDevices.length} thi·∫øt b·ªã`);
  } catch (e) {
    toast(msg, "C√≥ l·ªói x·∫£y ra: " + e.message);
  }
});

// Bulk turn off all  
qs("#btnTurnOffAll").addEventListener("click", async () => {
  const onDevices = currentDevices.filter(d => d.status);
  if (onDevices.length === 0) {
    toast(msg, "T·∫•t c·∫£ thi·∫øt b·ªã ƒë√£ ƒë∆∞·ª£c t·∫Øt");
    return;
  }
  
  if (!confirm(`B·∫°n c√≥ mu·ªën t·∫Øt ${onDevices.length} thi·∫øt b·ªã?`)) return;
  
  try {
    for (const dev of onDevices) {
      await toggleDevice(dev.id, false);
      await addHistoryWithCircuit({ ...dev, status: false }, circuitId);
    }
    toast(msg, `ƒê√£ t·∫Øt ${onDevices.length} thi·∫øt b·ªã`);
  } catch (e) {
    toast(msg, "C√≥ l·ªói x·∫£y ra: " + e.message);
  }
});

if(!circuitId){
  listEl.innerHTML = `<div class="empty">Ch∆∞a c√≥ thi·∫øt b·ªã (ch∆∞a li√™n k·∫øt Id m·∫°ch). V√†o <b>Profile</b> ƒë·ªÉ c·∫≠p nh·∫≠t.</div>`;
}else{
  const unsub = listenDevicesByCircuit(circuitId, (devices)=>{
    renderDevices(listEl, devices, async (dev, newState)=>{
      try{
        // C·∫≠p nh·∫≠t device
        await toggleDevice(dev.id, newState);
        // Ghi l·ªãch s·ª≠ k√®m circuitId (ƒë·ªÉ d·ªÖ query theo m·∫°ch)
        await addHistoryWithCircuit({ ...dev, status:newState }, circuitId);
      }catch(e){
        toast(msg, e.message || "Kh√¥ng th·ªÉ ƒë·ªïi tr·∫°ng th√°i");
      }
    });
  });
  window.addEventListener("beforeunload", ()=>unsub && unsub());
}
</script>
</body>
</html>